define(["require","exports","tslib","react","spectrum-integrations/platform-interfaces","spectrum-integrations/error-helper","spectrum-integrations/share_form_body/share_form_body","spectrum-integrations/scooter_loader/scooter_loader"],function(e,t,i,s,n,a,r,o){"use strict";function c(e){return/^[^@]+@[^@]+\.[^@]+$/.test(e)||/^#[a-zA-Z0-9-]+$/.test(e)}Object.defineProperty(t,"__esModule",{value:!0});var l=(function(e){function t(t){var i=e.call(this,t)||this;return i.onPrimaryAction=function(){if(i.state.isTargetValid){var e=i.props.localization;i.sendMessage().then(function(t){i.showNotice({title:e.messageSentNotification,variant:"complete",actions:[{text:e.seeMessageActionLabel,onClick:function(e){i.props.openDeepLink(t.deep_link),e()}},n.getCloseAction(e)],timeout:n.DEFAULT_NOTICE_TIMEOUT}),i.props.onModalDismiss(!1)}).catch(function(t){i.showNotice(a.getErrorNotice(t,e,i.props.openDbxUrl))})}},i.onSecondaryAction=function(){i.props.onModalDismiss(!0)},i.handleTargetChange=function(e){i.setState({target:e.target.value,isTargetValid:c(e.target.value)})},i.handleMessageChange=function(e){i.setState({message:e.target.value})},i.state={isSending:!1,target:"",isTargetValid:!1,message:"",insufficientPermissions:!1,isLoading:!0,isSlackLinked:!1},i}return i.__extends(t,e),t.prototype.componentDidMount=function(){var e=this.props.targetUser;e&&e.email&&this.setState({target:e.email,isTargetValid:c(e.email)}),this.checkInitialState()},t.prototype.render=function(){var e=this.state,t=e.target,i=e.isTargetValid,n=e.message,a=e.insufficientPermissions,c=e.isLoading,l=e.isSlackLinked,p=this.props,h=p.localization,u=p.targetUser,g=p.openDbxUrl,d=!(!u||!u.email||u.email!==t);d&&u.display_name;return c?s.createElement(o.ScooterLoader,null):s.createElement(r.IntegrationsShareFormBody,{isTargetValid:i,target:t,onTargetChanged:this.handleTargetChange,message:n,onMessageChanged:this.handleMessageChange,localization:h,onPrimaryAction:this.onPrimaryAction,onSecondaryAction:this.onSecondaryAction,insufficientPermissions:a,isSlackLinked:l,openDbxUrl:g})},t.prototype.sendMessage=function(){return i.__awaiter(this,void 0,void 0,function(){var e,t,s,n,a,r;return i.__generator(this,function(i){switch(i.label){case 0:e=this.props,t=e.apiClient,s=e.localization,this.setState({isSending:!0}),this.showNotice({title:s.messageSendingNotification,variant:"sync",progress:0,actions:[]}),i.label=1;case 1:return i.trys.push([1,,4,5]),[4,this.getShareLink()];case 2:return n=i.sent(),a={target:this.state.target,message:this.state.message+" "+n},[4,t.ns("slack").rpc("send_direct_message",a,{})];case 3:return r=i.sent(),[2,r];case 4:return this.setState({isSending:!1}),[7];case 5:return[2]}})})},t.prototype.showNotice=function(e){this.state.activeNotice&&this.state.activeNotice.dismiss();var t=this.props.showNotice(e);this.setState({activeNotice:t})},t.prototype.checkInitialState=function(){return i.__awaiter(this,void 0,void 0,function(){var e,t,s,n,a,r,o,c;return i.__generator(this,function(i){switch(i.label){case 0:e=this.props.apiClient,t=!1,s=!1,i.label=1;case 1:return i.trys.push([1,3,,4]),[4,this.props.apiClient.ns("profile_services").rpc("service_permissions_state",{service:{".tag":"slack_dropbox"}},{})];case 2:return i.sent(),s=!0,[3,4];case 3:return n=i.sent(),s=!1,[3,4];case 4:return i.trys.push([4,6,,7]),a={file:this.props.fileId,actions:[{".tag":"create_link"}]},[4,e.ns("sharing").rpc("get_file_metadata",a,{})];case 5:return r=i.sent(),o=(r.permissions||[])[0],o&&o.allow||(t=!0),[3,7];case 6:return c=i.sent(),t=!0,[3,7];case 7:return this.setState({insufficientPermissions:t,isLoading:!1,isSlackLinked:s}),[2]}})})},t.prototype.getShareLink=function(){return i.__awaiter(this,void 0,void 0,function(){var e,t,s,n,a;return i.__generator(this,function(i){switch(i.label){case 0:return e=this.props.apiClient,t={path:this.props.fileId,direct_only:!0},[4,e.ns("sharing").rpc("list_shared_links",t,{})];case 1:return s=i.sent(),s.links.length?[2,s.links[0].url]:(n={path:this.props.fileId},[4,e.ns("sharing").rpc("create_shared_link_with_settings",n,{})]);case 2:return a=i.sent(),[2,a.url]}})})},t})(s.Component);t.IntegrationsStatefulShareBody=l});
//# sourceMappingURL=stateful_share_form_body.min.js-vfl0Se178.map