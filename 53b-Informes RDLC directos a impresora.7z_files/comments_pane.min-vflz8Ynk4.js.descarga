define(["require","exports","tslib","react","external/react-redux","modules/clean/react/css","external/classnames","spectrum_comments/comment","spectrum_comments/comment_editor","spectrum_comments/comment_stream","modules/clean/react/comments2/actions_adapters/index","modules/clean/react/comments2/components/legacy_annotations_bridge","modules/clean/react/comments2/components/onboarding","modules/clean/react/comments2/util","modules/clean/react/comments2/transforms","modules/clean/react/comments2/data/actions","modules/clean/react/comments2/data/selectors","modules/clean/react/comments2/data/mentions_api","modules/clean/react/file_viewer/more_dropdown/more_option_registry","modules/clean/react/file_action_button","modules/clean/react/file_viewer/more_dropdown/models","modules/clean/previews/constants","modules/clean/react/comments2/components/comments_translations","modules/clean/react/comments2/data/frame_message_listener","modules/clean/react/comments2/components/tooltips"],function(e,t,n,o,i,r,s,a,p,l,c,m,d,u,h,g,b,v,_,T,f,y,w,E,C){"use strict";function A(e,t){return void 0===t&&(t=1),e===y.PreviewType.SsrDoc?{type:"document",regionType:"rectangle",regions:[{page:t,x:0,y:0,width:1,height:1}]}:{type:"image",region:{page:t,x:0,y:0,width:1,height:1}}}function M(e){var t=e.currentPageNumber,i=e.disabledTimeCodeTooltipComponent,r=e.playerCurrentTime,s=void 0===r?0:r,a=e.pendingNumberedAnnotation,l=e.playerIntegrationEnabled,c=e.previewType,m=e.upsellTooltipComponent;if(c===y.PreviewType.Audio||c===y.PreviewType.Video){var d=void 0;m?d=m:l||(d=i);var u=c===y.PreviewType.Audio?"audio":"video";return o.default.createElement(p.TimeCodedCommentEditor,n.__assign({},e,{pendingAnnotation:{type:u,time:s},tooltipComponent:d}))}return c===y.PreviewType.SsrDoc||c===y.PreviewType.Image?o.default.createElement(p.NumberedCommentEditor,n.__assign({},e,{defaultAnnotation:A(c,t),pendingAnnotation:a})):o.default.createElement(p.CommentEditor,n.__assign({},e))}Object.defineProperty(t,"__esModule",{value:!0}),o=n.__importDefault(o),i=n.__importStar(i),s=n.__importDefault(s),b=n.__importStar(b);var O=function(e){var t=e.children,n=e.markOnboarded,i=e.playerIntegrationEnabled,r=e.previewType,s=e.showOnboarding,a=i?"target-annotation":"target-mention";return o.default.createElement(p.CoachMarkContainer,{className:a},t,s&&o.default.createElement(d.CoachMark,{markOnboarded:n,playerIntegrationEnabled:i,previewType:r}))},S=(function(e){function t(t){var i=e.call(this,t)||this;i.onCommentStreamRef=function(e){return i.commentStream=e},i.updateMentionsMatches=function(e){i.setState({mentionsMatches:e})},i.onMentionsQueryUpdated=function(e){e?i.mentionsApi.query(e,i.updateMentionsMatches):""===e&&i.updateMentionsMatches(i.mentionsApi.getMatchesWithStarterSuggestions())},i.toggleShowResolved=function(){var e=i.props,t=e.dispatch,n=e.showResolved,o=n?"hide_resolved_threads":"show_resolved_threads";t(g.Actions.toggleShowResolved()),t(g.Actions.logEvent(o))},i.setCommentsEnabled=function(){i.props.dispatch(g.Actions.enableCommenting())},i.setCommentsDisabled=function(){i.props.dispatch(g.Actions.disableCommenting())},i.createComment=function(e){switch(i.props.previewType){case y.PreviewType.Video:case y.PreviewType.Audio:return o.default.createElement(a.TimeCodedComment,n.__assign({},e,{playerIntegrationEnabled:i.props.playerIntegrationEnabled}));case y.PreviewType.Image:case y.PreviewType.SsrDoc:return o.default.createElement(a.NumberedComment,n.__assign({},e));default:return o.default.createElement(a.Comment,n.__assign({},e))}},i.createEditor=function(e){var t=i.props,r=t.currentPageNumber,s=t.pendingNumberedAnnotation,a=t.playerCurrentTime,p=t.playerIntegrationEnabled,l=t.previewType,c=t.showOnboarding,m=t.upsellTooltipVariant,d=m?i.createUpsellTooltip:void 0;return o.default.createElement(O,{markOnboarded:i.markOnboarded,playerIntegrationEnabled:p,previewType:l,showOnboarding:c},o.default.createElement(M,n.__assign({},e,{disabledTimeCodeTooltipComponent:i.createDisabledTimeCodeTooltip,upsellTooltipComponent:d,pendingNumberedAnnotation:s,currentPageNumber:r,playerCurrentTime:a,playerIntegrationEnabled:p,previewType:l})))},i.createDisabledTimeCodeTooltip=function(e){return o.default.createElement(C.DisabledTimeCodeTooltip,n.__assign({},e,{onClick:i.onDisabledTooltipLearnMoreClick,onShow:i.onDisabledTooltipShow}))},i.createUpsellTooltip=function(e){return o.default.createElement(C.UpsellTooltip,n.__assign({},e,{onClick:i.onUpsellTooltipClick,onDismiss:i.onUpsellTooltipDismiss,onShow:i.onUpsellTooltipShow,variant:i.props.upsellTooltipVariant}))},i.onDisabledTooltipLearnMoreClick=function(){return i.props.dispatch(g.Actions.logEvent("time_based_tooltip_learn_more_click"))},i.onDisabledTooltipShow=function(){return i.props.dispatch(g.Actions.logEvent("time_based_tooltip_learn_more_view"))},i.onUpsellTooltipClick=function(){i.props.dispatch(g.Actions.dismissUpsellTooltip(void 0)),i.props.dispatch(g.Actions.logEvent("time_based_tooltip_upgrade_click"))},i.onUpsellTooltipDismiss=function(){i.props.dispatch(g.Actions.dismissUpsellTooltip(void 0)),i.props.dispatch(g.Actions.logEvent("time_based_tooltip_upgrade_dismiss"))},i.onUpsellTooltipShow=function(){return i.props.dispatch(g.Actions.logEvent("time_based_tooltip_upgrade_view"))},i.markOnboarded=function(e){return i.props.dispatch(g.Actions.markOnboarded(e))};var r=t.dispatch,s=t.viewer,p=t.previewType;return i.mentionsApi=v.mentionsApi(s),p!==y.PreviewType.SsrDoc&&p!==y.PreviewType.Image||(i.frameMessageListener=new E.FrameMessageListener(r,p)),i.state={mentionsMatches:i.mentionsApi.cache},i}return n.__extends(t,e),t.prototype.buildResolveOption=function(){var e=this.props.showResolved?T.FileActionButtonType.HIDE_RESOLVED_COMMENTS:T.FileActionButtonType.SHOW_RESOLVED_COMMENTS;return new f.MoreOption({className:"comments-options-item__show-resolved",fileActionButtonType:e,component:function(e){return o.default.createElement("span",null,e.buttonText)},handler:this.toggleShowResolved})},t.prototype.buildEnableOption=function(){var e,t;return this.props.isEnabled?(e=T.FileActionButtonType.DISABLE_COMMENTS,t=this.setCommentsDisabled):(e=T.FileActionButtonType.ENABLE_COMMENTS,t=this.setCommentsEnabled),new f.MoreOption({className:"comments-options-item__disable",fileActionButtonType:e,component:function(e){return o.default.createElement("span",null,e.buttonText)},handler:t})},t.prototype.buildSubscribeOption=function(){var e,t,n=this;return this.props.isSubscribed?(e=T.FileActionButtonType.UNSUBSCRIBE,t=function(){return n.props.dispatch(g.Actions.unsubscribe(void 0))}):(e=T.FileActionButtonType.SUBSCRIBE,t=function(){return n.props.dispatch(g.Actions.subscribe(void 0))}),new f.MoreOption({className:"comments-options-item__subscribe",fileActionButtonType:e,component:function(e){return o.default.createElement("span",null,e.buttonText)},handler:t})},t.prototype.updateCommentsMoreOptionGroup=function(){var e=[];this.props.canEnable&&e.push(this.buildEnableOption()),e.push(this.buildResolveOption()),this.props.canSubscribe&&e.push(this.buildSubscribeOption());var t=new f.MoreOptionGroup({fileActionButtonGroup:T.FileActionButtonGroup.COMMENTS,options:e});void 0===this.moreOptionGroup?_.moreOptionRegistry.addOption(t):_.moreOptionRegistry.replaceOption(this.moreOptionGroup,t),this.moreOptionGroup=t},t.prototype.componentDidMount=function(){this.updateCommentsMoreOptionGroup();var e=this.props,t=e.dispatch,n=e.showOnboarding,o=e.perfEvents,i=+new Date;t(g.Actions.logEvent("show_comments")),t(g.Actions.logPerfEvent("stream_displayed_ms",i-(o.listCompleteTime||0))),t(g.Actions.logPerfEvent("comment_editor_tti_ms",i-(o.setContextTime||0))),n&&t(g.Actions.logEvent("sidebar_onboarding_shown"))},t.prototype.componentDidUpdate=function(e){var t=e.previewType,n=e.requestEditorFocus,o=e.showOnboarding,i=this.props,r=i.showOnboarding,s=i.dispatch,a=i.previewType,p=i.requestEditorFocus;this.updateCommentsMoreOptionGroup(),!o&&r&&s(g.Actions.logEvent("sidebar_onboarding_shown")),!n&&p&&(this.commentStream.focusPrimaryEditor(),s(g.Actions.fulfillEditorFocusRequest())),t!==a&&(null==a?this.frameMessageListener=void 0:a!==y.PreviewType.SsrDoc&&a!==y.PreviewType.Image||(this.frameMessageListener=new E.FrameMessageListener(s,a)))},t.prototype.componentWillUnmount=function(){this.moreOptionGroup&&_.moreOptionRegistry.removeOption(this.moreOptionGroup)},Object.defineProperty(t.prototype,"actionsAdapter",{get:function(){var e=this.props,t=e.dispatch,n=e.onboardingKeysToMark,o=e.pendingNumberedAnnotation,i=e.playerIntegrationEnabled,r=e.previewType,s=e.viewer;return c.createActionsAdapter(t,r,n,this.onMentionsQueryUpdated,i,this.frameMessageListener,s,o)},enumerable:!0,configurable:!0}),t.prototype.render=function(){var e,t=this.props,n=t.showResolved,i=t.isMobile,r=t.stream.id,a=t.viewer,p=t.activeThreadId,c=t.hoverThreadId,d=this.props.threads.filter(function(e){return n||!e.resolved});return a&&(e=h.dbxUserToIUser(a)),o.default.createElement("div",{className:s.default("comments-pane-wrapper",{"no-comment":u.isComments2Mobile()&&0===d.length})},o.default.createElement(l.CommentStream,{ref:this.onCommentStreamRef,id:r,actionsAdapter:this.actionsAdapter,commentComponent:this.createComment,editorComponent:this.createEditor,enabled:!0,isMobile:!!i,mentionsMatches:this.state.mentionsMatches,settings:{canAnnotate:!0,canComment:!0,canRead:!0},userPermissions:{canAnnotate:!0,canComment:!0,canRead:!0},threads:d,user:e,activeThreadID:p,hoverThreadID:c,showUnreadPill:u.canShowUnreadPill(),localization:w.commentsMasterLocalization}),this.frameMessageListener&&o.default.createElement(m.LegacyAnnotationsBridge,{frameMessageListener:this.frameMessageListener}))},t})(o.default.Component);t.CommentsPaneComponent=S;var P=i.connect(function(e){var t=b.getContext(e),n=t.stream,o=t.viewer,i=b.getData(e),r=i.perfEvents,s=i.upsellTooltipVariant;return{activeThreadId:b.getActivatedThreadId(e),hoverThreadId:b.getHoverThreadId(e),playerCurrentTime:b.getPlayerCurrentTime(e),playerIntegrationEnabled:b.getIsPlayerIntegrationEnabled(e),onboardingKeysToMark:b.getUnmarkedOnboardingKeysRelevantToCurrentFile(e),showOnboarding:b.getShowOnboardingOnCommentsPane(e),showResolved:b.getShowResolved(e),canEnable:b.getCanEnable(e),isEnabled:b.getIsEnabled(e),canSubscribe:b.getCanSubscribe(e),isSubscribed:b.getIsSubscribed(e),pendingNumberedAnnotation:b.getPendingNumberedAnnotation(e),previewType:b.getPreviewTypeForCurrentFile(e),currentPageNumber:b.getCurrentPageNumber(e),stream:n,threads:b.getThreads(e),viewer:o,upsellTooltipVariant:s,perfEvents:r,requestEditorFocus:b.getIsEditorFocusRequested(e)}})(S);t.CommentsPane=r.requireCssWithComponent(P,["/static/js/spectrum_comments/index.web-vfl9XDK1R.css","/static/css/comments2-sidebar-vflRbFILB.css","/static/css/comments_annotations-vflGmnixA.css","/static/css/snackbar-vflLtw9Um.css"])});
//# sourceMappingURL=comments_pane.min.js-vflbdthIb.map